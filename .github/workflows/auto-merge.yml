name: Auto Merge Release Branches

on:
  push:
    branches:
      - 'main'

jobs:
  auto-merge:
    runs-on: ubuntu-latest    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get branch info
        id: branch-info
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒåˆ†æ”¯: $BRANCH_NAME"

      - name: Merge to dev branch
        id: merge
        run: |
          BRANCH_NAME="${{ steps.branch-info.outputs.branch_name }}"
          
          # åˆ‡æ¢åˆ° dev åˆ†æ”¯
          git checkout dev
          git pull origin dev
          
          # å°è¯•åˆå¹¶ release åˆ†æ”¯
          echo "ğŸ”„ æ­£åœ¨åˆå¹¶ $BRANCH_NAME åˆ° dev åˆ†æ”¯..."
          
          if git merge "origin/$BRANCH_NAME" --no-ff -m "chore: merge $BRANCH_NAME into dev"; then
            echo "âœ… åˆå¹¶æˆåŠŸ"
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ åˆå¹¶å¤±è´¥ï¼Œå­˜åœ¨å†²çª"
            echo "merge_success=false" >> $GITHUB_OUTPUT
            git merge --abort
            exit 1
          fi

      - name: Push merged changes
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          echo "ğŸ“¤ æ¨é€åˆå¹¶åçš„æ›´æ”¹åˆ° dev åˆ†æ”¯..."
          git push origin dev

      # - name: Create merge summary
      #   if: steps.merge.outputs.merge_success == 'true'
      #   run: |
      #     BRANCH_NAME="${{ steps.branch-info.outputs.branch_name }}"
      #     echo "ğŸ‰ è‡ªåŠ¨åˆå¹¶å®Œæˆ!"
      #     echo "åˆ†æ”¯: $BRANCH_NAME â†’ dev"
      #     echo "æäº¤: $(git rev-parse HEAD)"
          
      #     # åˆ›å»º GitHub è¯„è®º (å¯é€‰)
      #     echo "MERGE_SUMMARY<<EOF" >> $GITHUB_ENV
      #     echo "ğŸ¤– **è‡ªåŠ¨åˆå¹¶å®Œæˆ** " >> $GITHUB_ENV
      #     echo "" >> $GITHUB_ENV
      #     echo "**åˆ†æ”¯**: \`$BRANCH_NAME\` â†’ \`dev\`" >> $GITHUB_ENV
      #     echo "**æäº¤**: \`$(git rev-parse --short HEAD)\`" >> $GITHUB_ENV
      #     echo "**æ—¶é—´**: $(date -u)" >> $GITHUB_ENV
      #     echo "EOF" >> $GITHUB_ENV

      # - name: Delete release branch (optional)
      #   if: steps.merge.outputs.merge_success == 'true'
      #   run: |
      #     BRANCH_NAME="${{ steps.branch-info.outputs.branch_name }}"
      #     echo "ğŸ—‘ï¸ åˆ é™¤å·²åˆå¹¶çš„å‘å¸ƒåˆ†æ”¯: $BRANCH_NAME"
          
      #     # åˆ é™¤è¿œç¨‹åˆ†æ”¯
      #     git push origin --delete "$BRANCH_NAME" || echo "âš ï¸ æ— æ³•åˆ é™¤è¿œç¨‹åˆ†æ”¯"
          
      #     # åˆ é™¤æœ¬åœ°åˆ†æ”¯
      #     git branch -D "$BRANCH_NAME" || echo "âš ï¸ æ— æ³•åˆ é™¤æœ¬åœ°åˆ†æ”¯"

  notify-failure:
    runs-on: ubuntu-latest
    needs: auto-merge
    if: failure()
    
    steps:
      - name: Notify merge failure
        run: |
          echo "âŒ è‡ªåŠ¨åˆå¹¶å¤±è´¥!"
          echo "åˆ†æ”¯: ${GITHUB_REF#refs/heads/}"
          echo "è¯·æ‰‹åŠ¨æ£€æŸ¥å¹¶è§£å†³å†²çª"