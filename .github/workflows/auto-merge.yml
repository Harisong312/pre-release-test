name: Auto Merge Release Branches

on:
  push:
    branches:
      - 'main'

jobs:
  auto-merge:
    runs-on: ubuntu-latest    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      # - name: Setup Git
      #   run: |
      #     git config --global user.name "github-actions[bot]"
      #     git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # - name: Get branch info
      #   id: branch-info
      #   run: |
      #     BRANCH_NAME=${GITHUB_REF#refs/heads/}
      #     echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      #     echo "å‘å¸ƒåˆ†æ”¯: $BRANCH_NAME"

      # - name: Create merge branch
      #   id: merge
      #   run: |
      #     BRANCH_NAME="${{ steps.branch-info.outputs.branch_name }}"
      #     MERGE_BRANCH="auto-merge/$BRANCH_NAME-to-dev-$(date +%s)"
          
      #     echo "merge_branch=$MERGE_BRANCH" >> $GITHUB_OUTPUT
      #     echo "source_branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
      #     # åˆ›å»ºæ–°çš„åˆå¹¶åˆ†æ”¯ï¼ŒåŸºäº dev åˆ†æ”¯
      #     git checkout dev
      #     git pull origin dev
      #     git checkout -b "$MERGE_BRANCH"
          
      #     # å°è¯•åˆå¹¶ release åˆ†æ”¯
      #     echo "ğŸ”„ æ­£åœ¨åˆå¹¶ $BRANCH_NAME åˆ°ä¸´æ—¶åˆ†æ”¯ $MERGE_BRANCH..."
          
      #     if git merge "origin/$BRANCH_NAME" --no-ff -m "chore: merge $BRANCH_NAME into dev"; then
      #       echo "âœ… åˆå¹¶æˆåŠŸ"
      #       echo "merge_success=true" >> $GITHUB_OUTPUT
      #     else
      #       echo "âŒ åˆå¹¶å¤±è´¥ï¼Œå­˜åœ¨å†²çª"
      #       echo "merge_success=false" >> $GITHUB_OUTPUT
      #       git merge --abort
      #       exit 1
      #     fi

      # - name: Push merge branch
      #   if: steps.merge.outputs.merge_success == 'true'
      #   run: |
      #     MERGE_BRANCH="${{ steps.merge.outputs.merge_branch }}"
      #     echo "ğŸ“¤ æ¨é€åˆå¹¶åˆ†æ”¯: $MERGE_BRANCH"
      #     git push origin "$MERGE_BRANCH"

      - name: Create Pull Request
        id: create-pr
        run: |
          SOURCE_BRANCH=dev
          MERGE_BRANCH=${GITHUB_REF#refs/heads/}
          
          echo "ğŸ”„ åˆ›å»º Pull Request: $MERGE_BRANCH -> dev"


          echo "MERGE_BRANCH -->$MERGE_BRANCH"
          echo "SOURCE_BRANCH --> $SOURCE_BRANCH"
          echo "GITHUB_REF --> https://api.github.com/repos/${{ github.repository }}/pulls"
          
          # åˆ›å»º PR
          PR_RESPONSE=$(curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d '{
              "title": "ğŸ¤– Auto-merge: '"$MERGE_BRANCH"' â†’ dev",
              "head": "'"$MERGE_BRANCH"'",
              "base": "'"$SOURCE_BRANCH"'",
              "body": "## ğŸ¤– è‡ªåŠ¨åˆå¹¶ Pull Request\n\n**æºåˆ†æ”¯**: `'"$MERGE_BRANCH"'`\n**ç›®æ ‡åˆ†æ”¯**: `'"$SOURCE_BRANCH"'`\n**åˆ›å»ºæ—¶é—´**: '"$(date -u)"'\n\n### ğŸ“ è¯´æ˜\nè¿™æ˜¯ä¸€ä¸ªç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºçš„ Pull Requestï¼Œç”¨äºå°†å‘å¸ƒåˆ†æ”¯åˆå¹¶åˆ°å¼€å‘åˆ†æ”¯ã€‚\n\n### âœ… æ£€æŸ¥æ¸…å•\n- [x] è‡ªåŠ¨åˆå¹¶æµ‹è¯•é€šè¿‡\n- [ ] ä»£ç å®¡æŸ¥\n- [ ] æµ‹è¯•éªŒè¯\n\n---\n*æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*"
            }')
          
          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.number')
          PR_URL=$(echo "$PR_RESPONSE" | jq -r '.html_url')
          
          if [ "$PR_NUMBER" != "null" ] && [ "$PR_NUMBER" != "" ]; then
            echo "âœ… Pull Request åˆ›å»ºæˆåŠŸ!"
            echo "PR ç¼–å·: #$PR_NUMBER"
            echo "PR é“¾æ¥: $PR_URL"
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          else
            echo "âŒ Pull Request åˆ›å»ºå¤±è´¥"
            echo "å“åº”: $PR_RESPONSE"
            exit 1
          fi

      # å¯é€‰ï¼šè‡ªåŠ¨åˆå¹¶ PRï¼ˆå¦‚æœå¯ç”¨ï¼‰
      - name: Auto-merge Pull Request
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pr_number }}"
          
          echo "ğŸ”„ å°è¯•è‡ªåŠ¨åˆå¹¶ PR #$PR_NUMBER"
          echo "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge"
          
          # å¯ç”¨è‡ªåŠ¨åˆå¹¶
          curl -L \
            -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge" \
            -d '{
              "commit_title": "ğŸ¤– Auto-merge: merge release branch into dev",
              "commit_message": "Automatically merged by GitHub Actions",
              "merge_method": "merge"
            }'

      # - name: Create merge summary
      #   if: steps.merge.outputs.merge_success == 'true'
      #   run: |
      #     BRANCH_NAME="${{ steps.branch-info.outputs.branch_name }}"
      #     echo "ğŸ‰ è‡ªåŠ¨åˆå¹¶å®Œæˆ!"
      #     echo "åˆ†æ”¯: $BRANCH_NAME â†’ dev"
      #     echo "æäº¤: $(git rev-parse HEAD)"
          
      #     # åˆ›å»º GitHub è¯„è®º (å¯é€‰)
      #     echo "MERGE_SUMMARY<<EOF" >> $GITHUB_ENV
      #     echo "ğŸ¤– **è‡ªåŠ¨åˆå¹¶å®Œæˆ** " >> $GITHUB_ENV
      #     echo "" >> $GITHUB_ENV
      #     echo "**åˆ†æ”¯**: \`$BRANCH_NAME\` â†’ \`dev\`" >> $GITHUB_ENV
      #     echo "**æäº¤**: \`$(git rev-parse --short HEAD)\`" >> $GITHUB_ENV
      #     echo "**æ—¶é—´**: $(date -u)" >> $GITHUB_ENV
      #     echo "EOF" >> $GITHUB_ENV

  notify-failure:
    runs-on: ubuntu-latest
    needs: auto-merge
    if: failure()
    
    steps:
      - name: Notify merge failure
        run: |
          echo "âŒ è‡ªåŠ¨åˆå¹¶å¤±è´¥!"
          echo "åˆ†æ”¯: ${GITHUB_REF#refs/heads/}"
          echo "æ— æ³•åˆ›å»ºè‡ªåŠ¨åˆå¹¶çš„ Pull Request"
          echo "è¯·æ‰‹åŠ¨æ£€æŸ¥å¹¶è§£å†³å†²çªï¼Œç„¶åæ‰‹åŠ¨åˆ›å»º PR"