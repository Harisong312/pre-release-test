name: Auto Merge Release Branches

on:
  push:
    branches:
      - 'main'

permissions:
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get branch info
        id: branch-info
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          SOURCE_BRANCH=dev
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "发布分支: $BRANCH_NAME"
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "合并目标分支: $SOURCE_BRANCH"

      - name: Create Pull Request
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr create --base ${{ steps.branch-info.outputs.source_branch }} --head ${{ steps.branch-info.outputs.branch_name }}

      # - name: Create Pull Request
      #   id: create-pr
      #   run: |
      #     SOURCE_BRANCH=dev
      #     MERGE_BRANCH=${{ steps.branch-info.outputs.branch_name }}
          
      #     echo "🔄 创建 Pull Request: $MERGE_BRANCH -> dev"
          
      #     # 创建 PR
      #     PR_RESPONSE=$(curl -L \
      #       -X POST \
      #       -H "Accept: application/vnd.github+json" \
      #       -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
      #       -H "X-GitHub-Api-Version: 2022-11-28" \
      #       "https://api.github.com/repos/${{ github.repository }}/pulls" \
      #       -d '{
      #         "title": "🤖 Auto-merge: '"$MERGE_BRANCH"' → dev",
      #         "head": "'"$MERGE_BRANCH"'",
      #         "base": "'"$SOURCE_BRANCH"'",
      #         "body": "## 🤖 自动合并 Pull Request\n\n**源分支**: `'"$MERGE_BRANCH"'`\n**目标分支**: `'"$SOURCE_BRANCH"'`\n**创建时间**: '"$(date -u)"'\n\n---\n*此 PR 由 GitHub Actions 自动创建*"
      #       }')
          
      #     PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.number')
      #     PR_URL=$(echo "$PR_RESPONSE" | jq -r '.html_url')
          
      #     if [ "$PR_NUMBER" != "null" ] && [ "$PR_NUMBER" != "" ]; then
      #       echo "✅ Pull Request 创建成功!"
      #       echo "PR 编号: #$PR_NUMBER"
      #       echo "PR 链接: $PR_URL"
      #       echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
      #       echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
      #     else
      #       echo "❌ Pull Request 创建失败"
      #       echo "响应: $PR_RESPONSE"
      #       exit 1
      #     fi

      # 可选：自动合并 PR（如果启用）
      - name: Auto-merge Pull Request
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pr_number }}"
          
          echo "🔄 尝试自动合并 PR #$PR_NUMBER"
          echo "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge"
          
          # 启用自动合并
          curl -L \
            -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge" \
            -d '{
              "commit_title": "🤖 Auto-merge: merge release branch into dev",
              "commit_message": "Automatically merged by GitHub Actions",
              "merge_method": "merge"
            }'

  notify-failure:
    runs-on: ubuntu-latest
    needs: auto-merge
    if: failure()
    
    steps:
      - name: Notify merge failure
        run: |
          echo "❌ 自动合并失败!"
          echo "分支: ${GITHUB_REF#refs/heads/}"
          echo "无法创建自动合并的 Pull Request"
          echo "请手动检查并解决冲突，然后手动创建 PR"