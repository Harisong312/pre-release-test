name: Auto Merge Release Branches

on:
  push:
    branches:
      - 'main'

permissions: write-all

jobs:
  auto-merge:
    runs-on: ubuntu-latest    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get branch info
        id: branch-info
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          SOURCE_BRANCH=dev
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒåˆ†æ”¯: $BRANCH_NAME"
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "åˆå¹¶ç›®æ ‡åˆ†æ”¯: $SOURCE_BRANCH"

      - name: Create Pull Request
        id: create-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
          --base ${{ steps.branch-info.outputs.source_branch }} \
          --head ${{ steps.branch-info.outputs.branch_name }} \
          --title "ğŸ¤– Auto-merge: ${{ steps.branch-info.outputs.branch_name }} â†’ ${{ steps.branch-info.outputs.source_branch }}" \
          --body "## ğŸ¤– Auto Merge Pull Request

          **Base Branch**\: \`${{ steps.branch-info.outputs.source_branch }}\`
          **Head Branch**\: \`${{ steps.branch-info.outputs.branch_name }}\`
          **Created Time**\: \`$(date -u)\`

          ---
          *This PR is created by GitHub Actions*")

          echo "PR_URL=$PR_URL" >> $GITHUB_OUTPUT

      # å¯é€‰ï¼šè‡ªåŠ¨åˆå¹¶ PRï¼ˆå¦‚æœå¯ç”¨ï¼‰
      - name: Auto-merge Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr merge ${{ steps.create-pr.outputs.PR_URL }} --merge
          # # å¯ç”¨è‡ªåŠ¨åˆå¹¶
          # curl -L \
          #   -X PUT \
          #   -H "Accept: application/vnd.github+json" \
          #   -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          #   -H "X-GitHub-Api-Version: 2022-11-28" \
          #   "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/merge" \
          #   -d '{
          #     "commit_title": "ğŸ¤– Auto-merge: merge release branch into dev",
          #     "commit_message": "Automatically merged by GitHub Actions",
          #     "merge_method": "merge"
          #   }'